name: Deploy Next.js to Server

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout Repository
          uses: actions/checkout@v3

        - name: Set up Node.js
          uses: actions/setup-node@v3
          with:
              node-version: 20

        - name: Install Dependencies
          run: |
              rm -f package-lock.json

        - name: Install Dependencies
          run: |
              npm install

        - name: Create .env file
          run: |
              echo "PORT=${{ vars.PORT }}" >> .env
              echo "NEXT_PUBLIC_STORYBOOK_DISABLECACHING=${{ vars.NEXT_PUBLIC_STORYBOOK_DISABLECACHING }}" >> .env
              echo "NEXT_PUBLIC_MATOMO_TRACKER=${{ vars.NEXT_PUBLIC_MATOMO_TRACKER }}" >> .env
              echo "NEXT_PUBLIC_STORYBLOK_EDITOR_SECRET=${{ secrets.NEXT_PUBLIC_STORYBLOK_EDITOR_SECRET }}" >> .env
              echo "NEXT_PUBLIC_STORYBLOK_TOKEN=${{ secrets.NEXT_PUBLIC_STORYBLOK_TOKEN }}" >> .env
              echo "REVALIDATE_SECRET=${{ secrets.REVALIDATE_SECRET }}" >> .env


        - name: Build meimberg.io
          run: |
              npm run build

        - name: Deploy to Server
          env:
              SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
              SERVER_USER: ${{ vars.SERVER_USER }}
              SERVER_HOSTNAME: ${{ vars.SERVER_HOSTNAME }}
              SERVER_ROOTDIR: ${{ vars.SERVER_ROOTDIR }}
          run: |

              mkdir -p ~/.ssh
              echo "$SSH_PRIVATE_KEY" > ~/.ssh/ssh_key
              chmod 600 ~/.ssh/ssh_key
              ssh-keyscan -H "$SERVER_HOSTNAME" >> ~/.ssh/known_hosts

              echo "Starting rsync"

              rsync -avz --delete \
                --exclude=/.ssh \
                --exclude=/.git \
                --exclude=/.github \
                --exclude=/.cache \
                --exclude=/.tmp \
                --exclude=/logs \
                --exclude=/database \
                --exclude=/data \
                --exclude=/src \
                --exclude=public/uploads \
                -e "ssh -i ~/.ssh/ssh_key" "${GITHUB_WORKSPACE}/" "$SERVER_USER"@"$SERVER_HOSTNAME":"$SERVER_ROOTDIR"

              ssh -i ~/.ssh/ssh_key "$SERVER_USER"@"$SERVER_HOSTNAME" "cd \"$SERVER_ROOTDIR\" && pm2 restart meimbergio"
              echo "meimberg.io - Wutz!"
